# test/unit/fixture/json-fixture

This contains test fixtures in either [DirectoryJSON][] or [Compact JSON][] format.

[memfs](https://npm.im/memfs) can load these fixtures as virtual filesystems. They were created by [`snapshot-fs`][snapshot-fs].

## Creating a Fixture

> [!NOTE]
>
> [`snapshot-fs`][snapshot-fs] requires Node.js v22.13.0 or newer.

To create a fixture, you can use [`snapshot-fs`][snapshot-fs].

Say we have a directory, `project`, with this simple structure:

```text
project
├── index.js
└── package.json
```

> [!IMPORTANT]
>
> **The entry point must be named `index.js`**. This is per convention.

<!-- prettier-ignore-start -->
> For this example, `project/package.json` was created by `npm init -y`. `project/index.js` contains:
>
> ```js
> module.exports = 'hello world';
> ```
<!-- prettier-ignore-end -->

To create a snapshot of this directory, execute:

```sh
npx snapshot-fs project.json --dir project
```

It should print:

```text
[INFO] Wrote DirectoryJSON of /path/to/project to project.json
```

`project.json` is in [DirectoryJSON][] format, and looks like this:

```json
{
  "/package.json": "{\n  \"name\": \"project\",\n  \"version\": \"1.0.0\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"test\": \"echo \\\"Error: no test specified\\\" && exit 1\"\n  },\n  \"keywords\": [],\n  \"author\": \"\",\n  \"license\": \"ISC\",\n  \"type\": \"commonjs\",\n  \"description\": \"\"\n}\n",
  "/index.js": "module.exports = \"hello world\";\n"
}
```

Now that you have a snapshot, you can use it in a test case:

- Test the policy generated by LavaMoat using the [`testPolicyForJSON`][testPolicyForJSON] AVA macro.
- See [`loadJSONFixture`][loadJSONFixture] for other use cases.

> [!IMPORTANT]
>
> Commit `project.json`, but not the `project` directory. See the [Modifying a Fixture][] section for why not!

### Fixtures with Binary Data

If you need to create a fixture containing binary data (_use case: native modules_), provide the `--binary` flag to [snapshot-fs][]:

```sh
npx snapshot-fs project.json --dir project --binary
```

This will create a fixture in [Compact JSON][] format, which is not intended to be human-readable. LavaMoat's test harnesses ([`testPolicyForJSON`][testPolicyForJSON], [`loadJSONFixture`][loadJSONFixture]) can work with either format.

## Modifying a Fixture

> New in [`snapshot-fs`][snapshot-fs] v3.1.0

How can we make changes to a JSON fixture without the original `project` directory? Changing `project.json` _in-situ_ seems onerous (and near-impossible, if the fixture is in [Compact JSON][] format). Instead, we can:

1. Use the `export` subcommand of [`snapshot-fs`][snapshot-fs] to re-create the `project` directory:

   ```sh
   npx snapshot-fs export project.json --dir project
   ```

   This will re-create the `project` directory from the snapshot. Careful; this can be destructive!

2. Make your changes in the `project` directory
3. Use [`snapshot-fs`][snapshot-fs] to replace the existing snapshot:

   ```sh
   npx snapshot-fs project.json --dir project
   ```

[snapshot-fs]: https://npm.im/snapshot-fs
[DirectoryJSON]: https://github.com/streamich/memfs/blob/1a731872623199670e073974bd8a21706c942239/src/volume.ts#L197
[Compact JSON]: https://jsonjoy.com/specs/compact-json
[testPolicyForJSON]: https://github.com/LavaMoat/LavaMoat/blob/f730968f823f2a35a784571db3b9ac5a03bac9d7/packages/node/test/unit/policy/macros.js#L148-L190
[loadJSONFixture]: https://github.com/LavaMoat/LavaMoat/blob/f730968f823f2a35a784571db3b9ac5a03bac9d7/packages/node/test/unit/json-fixture-util.js#L69-L107
[modifying a fixture]: #modifying-a-fixture
