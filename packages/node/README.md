# LavaMoat Node - a runtime for running LavaMoat-protected NodeJS applications

**NOTE: under rapid develop, not ready for production use, has not been audited, etc**

`lavamoat` is a NodeJS runtime where modules are defined in [SES][SesGithub] containers. It aims to reduce the risk of malicious code in the app dependency graph, known as "software supplychain attacks".

## LavaMoat Runtime Explained

LavaMoat differs from the standard node runtime in that it:

1. Enforces the app-specified LavaMoat policy

This tells the kernel what execution environment each module should be instantiated with, and what other modules may be brought in as dependencies.

2. Uses a custom LavaMoat kernel

This kernel enforces the LavaMoat policy. When requested, a module is initialized, usually by evaluation inside a SES container. LavaMoat accomplishes this by providing it's own `require()` to the runtime.

The result is a runtime that should work just as before, but provides some protection against supplychain attacks.

## Example

Create an entry point for node app using `express`.

`index.js`
```
const express = require('express')
const app = express()

app.get('/', function (req, res) {
  res.send('hello world')
})

app.listen(3000)
```

Now use the lavamoat command with the entry file.

```
$ lavamoat index.js --autoconfig
```

All of the modules that `index.js` needs are evaluated inside SES containers. A lavamoat policy object is generated from a recursive walk of the require() graph and immediately applied to the runtime (via --autoconfig), which is also written to disk at `./lavamoat/node/policy.json`. Commit this config file and regenerate it when your dependencies change.

**WARNING: Do not edit the autogenerated `policy.json` directly. It will be overwritten if a new bundle is created using LavaMoat. Instead, edit the `policy-override.json`.

## Install

With npm do:

```
npm i lavamoat
```

## Usage

```
Usage: browserify [entry files] {BROWSERIFY OPTIONS} --plugin [ lavamoat-browserify {OPTIONS} ]

Options:

 --autoconfig, -a  Generate a `policy.json` and `policy-override.json` in the current
                   working directory. Overwrites any existing policy files. The override policy is for making manual policy changes and always takes precedence over the automatically generated policy.

     --config, -c  Pass in policy. Accepts a policy object {} or a filepath string to the existing
                   policy. When used in conjunction with --autoconfig, specifies where to write the policy. Default: ./policy.json

   --override, -o  Pass in override policy. Accepts a policy object {} or a filepath string to the existing
                   override policy. Default: ./policy-override.json

Advanced Options:

    --prelude, -p  Omit the lavamoat prelude from the bundle.

--pruneconfig, -pc Remove redundant package entries from the policy.

--debugconfig, -dc Generate a `policy-debug.json` in the current working directory. Used for the
                   lavamoat visualisation tool.

      --debug, -d  Turn on extra logging for debugging.

       --help, -h  Show this message
```

## More Examples

### Run with Policy

This uses the existing policy files to run your app.

```bash
lavamoat index.js
```

Automatically searches for policy files inside `./lavamoat/node/`.

### Policy Override with Relative Path

This uses the override policy specified at `./policies/policy-override.json`.

```
$ lavamoat index.js --override './policies/policy-override.json'
```

### Pro Tips

having trouble reading thrown Errors?
try running with the `--debugMode` flag.
not safe for production.

have a dependency that wont quite work under LavaMoat?
try [patch-package](https://github.com/ds300/patch-package)
