# LavaMoat - a Browserify Plugin for creating LavaMoat-protected builds

**NOTE: under rapid develop, not ready for production use, has not been audited, etc**

`lavamoat-browserify` is a [browserify][BrowserifyGithub] plugin for generating app bundles protected by [LavaMoat](https://github.com/LavaMoat/overview), where modules are defined in [SES][SesGithub] containers. It aims to reduce the risk of malicious code in the app dependency graph, known as "software supplychain attacks".

[BrowserifyGithub]: https://github.com/browserify/browserify
[SesGithub]: https://github.com/agoric/SES

## Anatomy of a LavaMoat bundle

The `lavamoat-browserify` plugin replaces the last internal build step of the browserify [compiler pipeline](https://github.com/browserify/browserify-handbook#compiler-pipeline). This step takes all the modules and their metadata and outputs the final bundle content, including the kernel and LavaMoat configuration file.

LavaMoat builds differ from standard browserify builds in that they:

1. Include the app-specified LavaMoat configuration

This tells the kernel what execution environment each module should be instantiated with, and what other modules may be brought in as dependencies.

2. Use a custom LavaMoat kernel

This kernel enforces the LavaMoat config. When requested, a module is initialized, usually by evaluation inside a SES container.

3. Bundle the module sources as strings

Modules are SES eval'd with access only to the platform APIs specificied in the config.

The result is a bundle that should work just as before, but provides some protection against supplychain attacks.

## Example

Create a file, `index.js` with some requires.

```
const foo = require('./foo.js');
const gamma = require('gamma');

const elem = document.getElementById('result');
const x = foo(100);
elem.textContent = x;
```

Now use the browserify command with lavamoat as a plugin to build a lavamoat-protected bundle starting at `index.js`:

```
$ browserify index.js --plugin [ lavamoat-browserify --autoconfig ]
```

All of the modules that `index.js` needs are included in the `bundle.js` as strings to be evaluated inside SES containers. A lavamoat configuration object is generated from a recursive walk of the require() graph and injected into the bundle (via --autoconfig), which is also written to disk.

To use this bundle, just toss a <script src="bundle.js"></script> into your html, as per the official [browserify][BrowserifyGithub] documentation.

**Be sure to use the same Browserify configuration (eg. plugins and transforms like babelify) that you normally use, so that it can parse the code as it will appear in your final bundle.

## Install

With npm do:

```
npm i -g browserify lavamoat-browserify
```

## Usage

```
Usage: browserify [entry files] {BROWSERIFY OPTIONS} --plugin [ lavamoat-browserify {OPTIONS} ]

Options:

 --autoconfig, -a  Generate a `lavamoat-config.json` and `lavamoat-config-override.json` in the current
                   working directory. Overwrites any existing config files. The override config is for making manual config changes and always takes precedence over the automatically generated config.

     --config, -c  Pass in configuration. Accepts a config object {} or a filepath string to the existing
                   config. When used in conjunction with --autoconfig, specifies where to write the config. Default: ./lavamoat-config.json

   --override, -o  Pass in override config. Accepts a config object {} or a filepath string to the existing
                   override config. Default: ./lavamoat-config-override.json

Advanced Options:

    --prelude, -p  Omit the lavamoat prelude from the bundle.

--pruneconfig, -pc Factor out extra package entries from the config.

--debugconfig, -dc Generate a `lavamoat-config-debug.json` in the current working directory. Used for the
                   lavamoat visualisation tool.

      --debug, -d  Turn on extra logging for debugging.

       --help, -h  Show this message
```

## More Examples

### Config Override

You may wish to modify the config for finer control over package permissions.

**WARNING: Do not edit the autogenerated config `lavamoat-config.json` directly. It will be overwritten if a new bundle is created using LavaMoat. Instead, edit the `lavamoat-config-override.json`.

Run the command with the updated config to generate a new bundle. Automatically Searches for `lavamoat-config-override.json` inside the current working directory. Alternatively, pass it a relative path.

```
$ browserify index.js --plugin [ lavamoat-browserify --override ]
```

### browserify API

Create a browserify bundle with LavaMoat directly from the API and write it to `bundle.js`.

```javascript
const browserify = require('browserify')
const fs = require('fs')

const lavamoatOpts = {
  config: '../../lavamoat-config.json',
  override: '../../lavamoat-config-override.json',
  debugconfig: true,
  pruneconfig: true
}

const bundler = browserify(['./index.js'], {
  plugin: [
    ['lavamoat-browserify', lavamoatOpts]
  ]
})

bundler.bundle().pipe(fs.createWriteStream('./bundle.js'))
```

### Config Formats

Config as an `object`

```javascript
const lavamoatOpts = {
    config: {
        resources: {
             <root>: {
                 packages: {
                     react: true
                }
            }
        }
    }
}
```

Config as a `function`, must return a filepath or an `object`:

```javascript
const lavamoatOpts = {
    config: () => "./lavamoat/lavamoat-config.json"
}
```

OR

```javascript
const configObject = {
    resources: {
        <root>: {
            packages: {
                react: true
            }
        }
    }
}
const lavamoatOpts = {
    config: () => configObject
}
```

## Next Steps

### Add the generated bundle to your HTML

```html
<script src=bundle.js> </script>
```

And voila! Spin up a server and start using your LavaMoat protected Browserify build.

See [lavamoat-browserify examples](./examples/) for more usage examples.

### Config file explained

Here is an example of the config file with each field explained:

```
{
    “resources": {
        “<root>”: {
            "packages": {
                “react”: true,
            },
        },
        “react”: {
            "globals": {
                “console”: true,
                "window.postMessage": write
            }
        }
    }
}
```

* `"resources"`: All packages in your dependency graph accessible via `require()`.
* `"<root>"`: Entry point for the project's code, the "application package", such as `index.js`.
* `"packages"`: All packages accessible by the parent resource. In this example, `"<root>"` has access to `"react"`.This means that `"<root>"` can `require('react')`.
* `"globals"`: All platform APIs and global variables accessible by parent resource. In this example,`"react"` has access to `console`. Global access is read-only, unless defined by the `write` value. React can therefore read from AND mutate `window.postMessage`(!!).

### Introduction to LavaMoat Video

[![introduction to LavaMoat](https://img.youtube.com/vi/pOTEJy_FqIA/0.jpg)](https://www.youtube.com/watch?v=pOTEJy_FqIA)
